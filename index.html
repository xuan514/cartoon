<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ConvertCartoon</title>
<style>
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f0f0f0;
    }
    .title {
        font-size: 24px;
        margin-top: 20px;
    }
    .container {
        width: 1024px;
        display: flex;
        flex-wrap: wrap; /* 允許彈性布局換行 */
        justify-content: space-between;
        margin-top: 20px;
    }
    .upload-box{
        width: 48%;
        height: 350px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        border: 1px solid #ccc;
        background-color: #fff;
        margin-bottom: 5px;
        padding: 5px;
    }
    .download-box {
        width: 48%;
        height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        border: 1px solid #ccc;
        background-color: #fff;
        padding: 5px;
    }
    .upload-box img,
    .upload-box video {
        max-width: 100%; /* 不超出box */
        display: block; /* 讓圖片和視頻置中 */
        margin: 0 auto; /* 水平置中 */
    }
    form{
       margin: 10px; 
    }
    input[type='file'],input[type='submit'],input[type='reset'],#imagelabel,#videolabel{
        cursor: pointer;
    }
</style>
</head>
<body>

<div class="title">風格轉換生成器</div>

<div class="container">
    <div class="upload-box">
        <div>圖片預覽</div>
        <form id="imageform" enctype="multipart/form-data" method="post" >
            <img id="imagePreview" src="#" alt="Preview" style="width: auto; height: 250px; display: none;"><br>
            <label id="imagelabel" for="imageUpload">+ 點擊選擇圖片</label>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <span id="file-name"></span>
            <input type="reset" id="imageResetBtn" value="重選" style="display: none;">
            <input type="submit" id="imageConvertBtn" value="轉換" style="display: none;">
        </form>
    </div>
    <div class="upload-box">
        <div>影片預覽</div>
        <form id="videoform" enctype="multipart/form-data" method="post"  >
            <video id="videoPreview" controls style="width: auto; height: 240px; display: none;">
                <source src="#" type="video/mp4">
                瀏覽器沒有支援影片播放!
            </video><br>
            <label id="videolabel" for="videoUpload">+ 點擊選擇影片</label>
            <input type="file" id="videoUpload" accept="video/*" style="display: none;">
            <span id="video-file-name"></span>
            <input type="reset" id="videoResetBtn" value="重選" style="display: none;">
            <input type="submit" id="videoConvertBtn" value="轉換" style="display: none;">
        </form>
    </div>
    <div class="download-box">
        <div>轉換結果</div>
        <img id="convertedImg" src="#" alt="Converted Image" style="width: auto; height: 250px; display: none;"><br>
        <a id="downloadBtn" href="#" download="converted_image.jpg" style="display: none;">下載轉換後圖片</a>
    </div>
    <div class="download-box">
        <div>轉換結果</div>
        
    </div>
</div>

<script>
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const imageLabel = document.getElementById('imagelabel');
    const imageFileName = document.getElementById('file-name');
    const imageResetBtn = document.getElementById('imageResetBtn');
    const imageConvertBtn = document.getElementById('imageConvertBtn');
    const imageForm = document.getElementById('imageform');
    // 圖片預覽
    imageUpload.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // 顯示檔案名稱
            imageFileName.innerText = file.name;

            imageLabel.style.display = 'none';
            imageResetBtn.style.display = 'inline-block';
            imageConvertBtn.style.display = 'inline-block';
            // 顯示預覽圖片
            const reader = new FileReader();
            reader.onload = function() {
                imagePreview.src = reader.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }else{
            // 如果沒有選擇文件，隱藏預覽和檔案名稱
            imagePreview.style.display = 'none';
            imageFileName.innerText = '';
            imageResetBtn.style.display = 'none';
            imageConvertBtn.style.display = 'none';
        }
    });
    // 圖片重選
    imageResetBtn.addEventListener('click', function() {
        imageUpload.value = ''; // 清除已選擇的文件
        imageFileName.innerText = ''; // 清除檔案名稱

        imagePreview.style.display = 'none'; 
        this.style.display = 'none'; 
        imageConvertBtn.style.display = 'none';
        imageLabel.style.display = 'inline-block';
    });
    // 檔案轉換
    imageForm .addEventListener('submit', function(event) {
        const fileType = imageUpload.value.split('.').pop().toLowerCase();
        if(fileType !== 'jpg' && fileType !== 'jpeg' && fileType !== 'png' && fileType !== 'gif'){    
            alert('請選取圖片格式的檔案!!');
            event.preventDefault();
        }else{
            const file = imageUpload.files[0];
            const fs = require('fs');
            const path = require('path');
            const glob = require('glob');
            const { promisify } = require('util');
            const tf = require('@tensorflow/tfjs-node');
            
            const utils = require('./tools/utils');
            const generator = require('./net/generator');
            
            async function parseArgs() {
                // 解析命令行參數
                // 請自行替換以下變數的默認值
                return {
                    checkpointDir: 'checkpoint/generator_Hayao_weight',
                    testDir: 'file',
                    saveDir: '/',
                    ifAdjustBrightness: true
                };
            }
            
            function checkFolder(folder) {
                // 檢查並創建目錄
                if (!fs.existsSync(folder)) {
                    fs.mkdirSync(folder, { recursive: true });
                }
            }
            
            async function test(checkpointDir, styleName, testDir, ifAdjustBrightness, imgSize = [256, 256]) {
                // 創建結果目錄
                const resultDir = path.join('results', styleName);
                checkFolder(resultDir);
            
                // 獲取測試文件列表
                const testFiles = await promisify(glob)(path.join(testDir, '*.*'));
            
                // 加載模型
                const model = new generator.G_net(); // 使用生成器類別創建模型
                const testReal = tf.tensor([], [1, null, null, 3], 'float32', 'test');
                model.build([1, ...imgSize, 3]);
                model(fake);
            
                const checkpoint = tf.train.getCheckpointState(checkpointDir); // 獲取檢查點狀態
                if (checkpoint && checkpoint.modelCheckpointPath) { // 如果存在檢查點
                    const ckptName = path.basename(checkpoint.modelCheckpointPath); // 獲取檢查點文件名
                    await model.loadWeights(path.join(checkpointDir, ckptName)); // 加載權重
                    console.log(`[*] Success to read ${path.join(checkpointDir, ckptName)}`); // 輸出成功讀取模型的信息
                } else {
                    console.log(" [*] Failed to find a checkpoint"); // 輸出找不到檢查點的信息
                    return;
                }
            
                begin = Date.now();
                for (const sampleFile of testFiles) {
                    // 加載測試圖片數據
                    const sampleImage = utils.loadTestData(sampleFile, imgSize);
                    const imagePath = path.join(resultDir, path.basename(sampleFile)); // 結果圖片保存路徑
                    const fakeImg = model.predict(sampleImage); // 生成假圖像
                    if (ifAdjustBrightness) {
                        utils.saveImages(fakeImg, imagePath, sampleFile); // 保存調整亮度後的圖像
                    } else {
                        utils.saveImages(fakeImg, imagePath, null); // 保存原始圖像
                    }
                }
                end = Date.now();
                console.log(`test-time: ${end - begin} ms`); // 輸出測試時間
                console.log(`one image test time: ${(end - begin) / testFiles.length} ms`); // 輸出單張圖像測試時間
            }
            
            async function main() {
                const args = await parseArgs(); // 解析命令行參數
                console.log(args.checkpointDir); // 輸出檢查點目錄
                await test(args.checkpointDir, args.saveDir, args.testDir, args.ifAdjustBrightness); // 執行測試
            }
            main(); // 主函數入口點
        }
    });

    const videoUpload = document.getElementById('videoUpload');
    const videoPreview = document.getElementById('videoPreview');
    const videoLabel = document.getElementById('videolabel');
    const videoFileName = document.getElementById('video-file-name');
    const videoResetBtn = document.getElementById('videoResetBtn');
    const videoConvertBtn = document.getElementById('videoConvertBtn');
    const videoForm = document.getElementById('videoform');
    // 影片預覽
    videoUpload.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // 顯示檔案名稱
            videoFileName.innerText = file.name;
            // 顯示重選按鈕
            videoLabel.style.display = 'none';
            videoResetBtn.style.display = 'inline-block';
            videoConvertBtn.style.display = 'inline-block';
            // 顯示預覽影片
            const reader = new FileReader();
            reader.onload = function() {
                videoPreview.src = reader.result;
                videoPreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }else {
            // 如果沒有選擇文件，隱藏預覽和檔案名稱
            videoPreview.style.display = 'none';
            videoFileName.innerText = '';
            // 隱藏重選按鈕
            videoResetBtn.style.display = 'none';
            videoConvertBtn.style.display = 'none';
        }
    });
     // 影片重選
     videoResetBtn.addEventListener('click', function() {
        videoUpload.value = ''; // 清除已選擇的文件
        videoFileName.innerText = ''; // 清除檔案名稱
        videoPreview.style.display = 'none'; // 隱藏預覽影片
        this.style.display = 'none'; // 隱藏重選按鈕
        videoConvertBtn.style.display = 'none';
        videoLabel.style.display = 'inline-block';
    });
    // 檔案轉換
    videoForm.addEventListener('submit', function(event) {
        
    });

</script>

</body>
</html>
