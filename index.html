<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convert</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.12.0/dist/tf.min.js"></script>
<link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script defer src="https://pyscript.net/alpha/pyscript.js"></script>
<py-env>
    - numpy
    - requests
    - tqdm
    - glob
</py-env>
<style>
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f0f0f0;
    }
    .title {
        font-size: 24px;
        margin-top: 20px;
    }
    .container {
        width: 1024px;
        display: flex;
        flex-wrap: wrap; /* 允許彈性布局換行 */
        justify-content: space-between;
        margin-top: 20px;
    }
    .upload-box{
        width: 48%;
        height: 350px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        border: 1px solid #ccc;
        background-color: #fff;
        margin-bottom: 5px;
        padding: 5px;
    }
    .download-box {
        width: 48%;
        height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        border: 1px solid #ccc;
        background-color: #fff;
        padding: 5px;
    }
    .upload-box img,
    .upload-box video {
        max-width: 100%; /* 不超出box */
        display: block; /* 讓圖片和視頻置中 */
        margin: 0 auto; /* 水平置中 */
    }
    form{
       margin: 10px; 
    }
    input[type='file'],input[type='submit'],input[type='reset'],#imagelabel,#videolabel{
        cursor: pointer;
    }
</style>
</head>
<body>

<div class="title">風格轉換器</div>

<div class="container">
    <div class="upload-box">
        <div>圖片預覽</div>
        <form id="imageform" enctype="multipart/form-data" method="post" >
            <img id="imagePreview" src="#" alt="Preview" style="width: auto; height: 250px; display: none;"><br>
            <label id="imagelabel" for="imageUpload">+ 點擊選擇圖片</label>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <span id="file-name"></span>
            <input type="reset" id="imageResetBtn" value="重選" style="display: none;">
            <input type="submit" id="imageConvertBtn" value="轉換" style="display: none;">
        </form>
    </div>
    <div class="upload-box">
        <div>影片預覽</div>
        <form id="videoform" enctype="multipart/form-data" method="post"  >
            <video id="videoPreview" controls style="width: auto; height: 240px; display: none;">
                <source src="#" type="video/mp4">
                瀏覽器沒有支援影片播放!
            </video><br>
            <label id="videolabel" for="videoUpload">+ 點擊選擇影片</label>
            <input type="file" id="videoUpload" accept="video/*" style="display: none;">
            <span id="video-file-name"></span>
            <input type="reset" id="videoResetBtn" value="重選" style="display: none;">
            <input type="submit" id="videoConvertBtn" value="轉換" style="display: none;">
        </form>
    </div>
    <div class="download-box">
        <div>轉換結果</div>
        <img id="convertedImg" src="#" alt="Converted Image" style="width: auto; height: 250px; display: none;"><br>
        <a id="downloadBtn" href="#" download="converted_image.jpg" style="display: none;">下載轉換後圖片</a>
    </div>
    <div class="download-box">
        <div>轉換結果</div>
        
    </div>
</div>

<script>
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const imageLabel = document.getElementById('imagelabel');
    const imageFileName = document.getElementById('file-name');
    const imageResetBtn = document.getElementById('imageResetBtn');
    const imageConvertBtn = document.getElementById('imageConvertBtn');
    const imageForm = document.getElementById('imageform');
    const file = imageUpload.files[0];
    // 圖片預覽
    imageUpload.addEventListener('change', function() {
        if (file) {
            // 顯示檔案名稱
            imageFileName.innerText = file.name;

            imageLabel.style.display = 'none';
            imageResetBtn.style.display = 'inline-block';
            imageConvertBtn.style.display = 'inline-block';
            // 顯示預覽圖片
            const reader = new FileReader();
            reader.onload = function() {
                imagePreview.src = reader.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }else{
            // 如果沒有選擇文件，隱藏預覽和檔案名稱
            imagePreview.style.display = 'none';
            imageFileName.innerText = '';
            imageResetBtn.style.display = 'none';
            imageConvertBtn.style.display = 'none';
        }
    });
    // 圖片重選
    imageResetBtn.addEventListener('click', function() {
        imageUpload.value = ''; // 清除已選擇的文件
        imageFileName.innerText = ''; // 清除檔案名稱

        imagePreview.style.display = 'none'; 
        this.style.display = 'none'; 
        imageConvertBtn.style.display = 'none';
        imageLabel.style.display = 'inline-block';
    });
    
    // 圖片轉換
    imageForm .addEventListener('submit', function(event) {
        const fileType = imageUpload.value.split('.').pop().toLowerCase();
        if(fileType !== 'jpg' && fileType !== 'jpeg' && fileType !== 'png' && fileType !== 'gif'){    
            alert('請選取圖片格式的檔案!!');
            event.preventDefault();
        }else{
    <py-script>
        import sys
        sys.path.append('/tools')
        sys.path.append('/net')
        import argparse
        from tools.utils import *
        import os
        from tqdm import tqdm
        from glob import glob
        import time
        import numpy as np
        import tensorflow as tf
        from net import generator
        os.environ["CUDA_VISIBLE_DEVICES"] = "0"
        
        def parse_args():
            desc = "AnimeGANv2"
            parser = argparse.ArgumentParser(description=desc)
        
            parser.add_argument('--checkpoint_dir', type=str, default='checkpoint/'+'generator_Hayao_weight',
                                help='Directory name to save the checkpoints')
            parser.add_argument('--test_dir', type=str, default=<script>'file'</script>,
                                help='Directory name of test photos')
            parser.add_argument('--save_dir', type=str, default='convertimg',
                                help='what style you want to get')
            parser.add_argument('--if_adjust_brightness', type=bool, default=True,
                                help='adjust brightness by the real photo')
        
            """checking arguments"""
        
            return parser.parse_args()
        
        def stats_graph(graph):
            flops = tf.profiler.profile(graph, options=tf.profiler.ProfileOptionBuilder.float_operation())
            # params = tf.profiler.profile(graph, options=tf.profiler.ProfileOptionBuilder.trainable_variables_parameter())
            #print('FLOPs: {}'.format(flops.total_float_ops))
        
        def test(checkpoint_dir, style_name, test_dir, if_adjust_brightness, img_size=[256,256]):
            # tf.reset_default_graph()
            result_dir = 'result/img'+style_name
            check_folder(result_dir)
            test_files = glob('{}/*.*'.format(test_dir))
        
            test_real = tf.placeholder(tf.float32, [1, None, None, 3], name='test')
        
            with tf.variable_scope("generator", reuse=False):
                test_generated = generator.G_net(test_real).fake
            saver = tf.train.Saver()
        
            gpu_options = tf.GPUOptions(allow_growth=True)
            with tf.Session(config=tf.ConfigProto(allow_soft_placement=True, gpu_options=gpu_options)) as sess:
                # tf.global_variables_initializer().run()
                # load model
                ckpt = tf.train.get_checkpoint_state(checkpoint_dir)  # checkpoint file information
                if ckpt and ckpt.model_checkpoint_path:
                    ckpt_name = os.path.basename(ckpt.model_checkpoint_path)  # first line
                    saver.restore(sess, os.path.join(checkpoint_dir, ckpt_name))
                    #print(" [*] Success to read {}".format(os.path.join(checkpoint_dir, ckpt_name)))
                else:
                    #print(" [*] Failed to find a checkpoint")
                    return
                # stats_graph(tf.get_default_graph())
        
                begin = time.time()
                for sample_file  in tqdm(test_files) :
                    # print('Processing image: ' + sample_file)
                    sample_image = np.asarray(load_test_data(sample_file, img_size))
                    image_path = os.path.join(result_dir,'{0}'.format(os.path.basename(sample_file)))
                    fake_img = sess.run(test_generated, feed_dict = {test_real : sample_image})
                    if if_adjust_brightness:
                        save_images(fake_img, image_path, sample_file)
                    else:
                        save_images(fake_img, image_path, None)
                end = time.time()
                #print(f'test-time: {end-begin} s')
                #print(f'one image test time : {(end-begin)/len(test_files)} s')
        if __name__ == '__main__':
            import os
        
            os.environ['CUDA_VISIBLE_DEVICES'] = '/gpu:0'
        
            arg = parse_args()
            print(arg.checkpoint_dir)
            test(arg.checkpoint_dir, arg.save_dir, arg.test_dir, arg.if_adjust_brightness)
    
    </py-script>
        }
    });
</script>
<script>  
    const videoUpload = document.getElementById('videoUpload');
    const videoPreview = document.getElementById('videoPreview');
    const videoLabel = document.getElementById('videolabel');
    const videoFileName = document.getElementById('video-file-name');
    const videoResetBtn = document.getElementById('videoResetBtn');
    const videoConvertBtn = document.getElementById('videoConvertBtn');
    const videoForm = document.getElementById('videoform');
    // 影片預覽
    videoUpload.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // 顯示檔案名稱
            videoFileName.innerText = file.name;
            // 顯示重選按鈕
            videoLabel.style.display = 'none';
            videoResetBtn.style.display = 'inline-block';
            videoConvertBtn.style.display = 'inline-block';
            // 顯示預覽影片
            const reader = new FileReader();
            reader.onload = function() {
                videoPreview.src = reader.result;
                videoPreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }else {
            // 如果沒有選擇文件，隱藏預覽和檔案名稱
            videoPreview.style.display = 'none';
            videoFileName.innerText = '';
            // 隱藏重選按鈕
            videoResetBtn.style.display = 'none';
            videoConvertBtn.style.display = 'none';
        }
    });
     // 影片重選
     videoResetBtn.addEventListener('click', function() {
        videoUpload.value = ''; // 清除已選擇的文件
        videoFileName.innerText = ''; // 清除檔案名稱
        videoPreview.style.display = 'none'; // 隱藏預覽影片
        this.style.display = 'none'; // 隱藏重選按鈕
        videoConvertBtn.style.display = 'none';
        videoLabel.style.display = 'inline-block';
    });
    // 檔案轉換
    videoForm.addEventListener('submit', function(event) {
        
    });

</script>

</body>
</html>
